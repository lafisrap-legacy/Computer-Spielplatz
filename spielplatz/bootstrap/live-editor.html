<!DOCTYPE html>
<html lang="de">
<head>
<title>{{ .Title }}</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="static/css/bootstrap.min.css">
<link rel="stylesheet" href="static/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="static/css/spielplatz.css">
<link rel="stylesheet" href="build/css/live-editor.core_deps.css"/>
<link rel="stylesheet" href="build/css/live-editor.audio.css"/>
<link rel="stylesheet" href="build/css/live-editor.tooltips.css"/>
<link rel="stylesheet" href="build/css/live-editor.ui.css"/>
<script src="static/js/jquery-2.1.4.min.js"></script>
<!-- Live editor script files-->
<script src="build/js/live-editor.core_deps.js"></script>
<script src="build/js/live-editor.editor_ace_deps.js"></script>
<script src="build/js/live-editor.audio.js"></script>
<script src="build/js/live-editor.shared.js"></script>
<script src="build/js/live-editor.tooltips.js"></script>
<script src="build/js/live-editor.ui.js"></script>
<script src="build/js/live-editor.editor_ace.js"></script>
<!-- RIDDLE: Modal dialogs won't work if live-editor file are called after bootstrap.js -->
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/websockets.js"></script>
</head>
<body>
<div class="container">
    <div id="control-bar-yes-no-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">You forgot to set the title!</h4>
          </div>
          <div class="modal-body">
            <p>You forgot to set the body text&hellip;</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="modal-yes btn btn-default" data-dismiss="modal">?</button>
            <button type="button" class="modal-no btn btn-primary" data-dismiss="modal">?</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->    

    <div class="login-area">
        {{if not .UserName }}
            <a href="/login/live-editor" class="btn btn-info btn-sm pull-right">{{ .LoginLogin }} <span class="glyphicon glyphicon-share-alt"></span></a>
            <a href="/signup/live-editor" class="btn btn-info btn-sm pull-right">{{ .LoginSignup }} <span class="glyphicon glyphicon-book"></span></a>
        {{else}}
            <a href="/logout" id="logout-button" class="btn btn-info btn-sm pull-right">{{ .LoginLogout }} '{{ .UserName }}' <span class="glyphicon glyphicon-search"></span></a>        
        {{end}}
    </div>
    <div class="clearfix"></div>
    <div id="top-control-bar">
    </div>
    <div id="cpg-live-editor" class="span12"></div>
    {{ if .UserName }}
    <div id="bottom-control-bar">
        <button id="control-bar-new" class="btn btn-primary btn-sm">{{ .ControlBarNew }}</button>
        <span class="dropdown">
            <button class="btn btn-primary dropdown-toggle btn-md" type="button" data-toggle="dropdown">
                <span id= "control-bar-current-file"></span>
                <span class="caret"></span></button>
                <ul id= "control-bar-files" class="dropdown-menu">
                </ul>
        </span>
        <button id="control-bar-delete" class="btn btn-primary btn-sm">{{ .ControlBarDelete }}</button>
        <span class="dropdown" style="float: right">
            <button class="btn btn-primary dropdown-toggle btn-md" type="button" data-toggle="dropdown"><span id= "control-bar-label">{{ .ControlBarLabel }}</span>
                <span class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a id="control-bar-save">{{ .ControlBarSave }}</a></li>
                    <li><a id="control-bar-saveas">{{ .ControlBarSaveAs }}</a></li>
                    <li><a id="control-bar-version">{{ .ControlBarVersion }}</a></li>
                    <li><a id="control-bar-history">{{ .ControlBarHistory }}</a></li>
                </ul>
        </span>
        <form id="control-bar-input" class="form-inline" role="form" action="" style="float:right">  
             <div class="form-group col-sm-3">
                 <input class="form-control" type="text" name="filename" value="{{ .ControlBarNewFile }}" placeholder="Description" style="display:none"/>
             </div>
        </form>
  </div>
  {{ else }}
    <div id="bottom-control-bar">
        <span class="label label-info">{{ .ControlBarNoUser }}</span>
    </div>  
  {{ end }}
</div>

<script>
(function() {

////////////////////////////////////////////////////////////////////////////////////////////////
// Live-Editor !
window.liveEditor = new LiveEditor({
    el: $("#cpg-live-editor"),
    code: window.localStorage["test-code"] || "",
    width: 400,
    height: 400,
    editorHeight: "400px",
    autoFocus: true,
    workersDir: "../build/workers/",
    execFile: "external/output.html",
    externalsDir: "../build/external/",
    imagesDir: "../build/images/",
    jshintFile: "../build/external/jshint/jshint.js"
});

/////////////////////////////////////////////////////////////////////////////////////////////////
// Live Editor page logic
//
// If User changed: clear everything from localStorage
if( localStorage.userName !== "{{ .UserName }}") {
    var fileList = localStorage.codeFileList && JSON.parse(localStorage.codeFileList) || [];
    for( var i=0 ; i<fileList.length ; i++ ) localStorage.removeItem(fileList[i]);
    localStorage.removeItem("codeFileList");
    localStorage.removeItem("allFileList");
    localStorage.removeItem("currentCodeFile");
    localStorage.userName = "{{ .UserName }}";
}

//////////////////////////////////////////
// Fill in the globals form local storage
var CPG_userName = localStorage.userName,
    CPG_codeFileList = localStorage.codeFileList && JSON.parse(localStorage.codeFileList) || [],
    CPG_allFileList = localStorage.allFileList && JSON.parse(localStorage.allFileList) || [],
    CPG_currentCodeFile = localStorage.currentCodeFile,
    CPG_codeFiles = {};

for( var i=0 ; i<CPG_codeFileList.length ; i++ ) CPG_codeFiles[CPG_codeFileList[i]] = localStorage[CPG_codeFileList[i]] && JSON.parse(localStorage[CPG_codeFileList[i]]) || {};
CPG_codeFiles[{{ .ControlBarNewFile }}] = localStorage[{{ .ControlBarNewFile }}] && JSON.parse(localStorage[{{ .ControlBarNewFile }}]) || {};

///////////////////////////////////////////
// showModal displays a modal dialog with answers yes and no
var showModal = function(title, body, cb) {
    var modal = $("#control-bar-yes-no-modal")

    $(".modal-title", modal).text(title);
    $(".modal-body", modal).text(body);
    $(".modal-yes", modal).text("{{ .ControlBarYes }}").one("click", function(e) {
        cb(true);
        modal.modal('hide');
    });
    $(".modal-no", modal).text("{{ .ControlBarNo }}").one("click", function(e) {
        modal.modal('hide');
    });

    modal.modal('show');
    modal.one('hide.bs.modal', function(e) {
        cb(false);
    });
};

////////////////////////////////////////////
// storeCurrentCodeFile syncs the current code file with the global variable and the local storage
var storeCurrentCodeFile = function() {
    CPG_codeFiles[CPG_currentCodeFile].code = liveEditor.editor.text();
    localStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile]);    
};

/////////////////////////////////////////////
// fillButtonControl fills the file select button with current files
var fillButtonControl = function() {

    // create file list for button control
    var fileList = [];
    for( var i=0 ; i<CPG_codeFileList.length ; i++ ) {
        fileList.push({
            fileName: CPG_codeFileList[i],
            timeStamp: CPG_codeFiles[CPG_codeFileList[i]].timeStamp
        });
    }

    fileList.sort(function(a,b) {
        if( a.timeStamp > b.timeStamp ) return -1;
        else return 1;
    });

    var cbf = $("#control-bar-files"),
        width = cbf.width();

    cbf.html("");
    for( var i=0 ; i<fileList.length ; i++ ) {

        cbf.append('<li><span class="control-bar-file" codefile="'+fileList[i].fileName+'">'+fileList[i].fileName+'<span class="timestamp">'+getFormatedDate(fileList[i].timeStamp)+'</span></span></li>')
            .width(width + 20); 
    }

    if( CPG_allFileList.length > CPG_codeFileList.length ) {
        cbf.append('<li class="border-top"><span class="control-bar-file" codefile="all">{{ .ControlBarAllFiles }}</span></li>')
    }

    $("#control-bar-current-file").text(CPG_currentCodeFile);
    $("#control-bar-input input").val(CPG_currentCodeFile);

    $(".control-bar-file").on('click', function(e) {
        if( CPG_currentCodeFile !== "{{ .ControlBarNewFile }}" ) {
            storeCurrentCodeFile();
        }
 
        localStorage.currentCodeFile = CPG_currentCodeFile = $(this).attr("codeFile");
        $("#control-bar-current-file").text(CPG_currentCodeFile);
        $("#control-bar-input input").val(CPG_currentCodeFile)
        liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile].code);
    });
};

///////////////////////////////////////////
// getFormatedDate returns a neatly formated date or time
var getFormatedDate = function(time) {
    if( !time ) return "";

    var monthNames = ["Jan.", "Feb.", "MÃ¤rz", "Apr.", "Mai", "Juni", "Juli", "Aug.", "Sep.", "Okt.", "Nov.", "Dez."];

    var date = new Date(),
        today = date.toDateString(),
        yearNow = date.getFullYear(),
        yesterday = date.setDate(date.getDate()-1);
    yesterday = date.toDateString();

    date.setTime(time);
    var day = date.getDate(),
        monthIndex = date.getMonth(),
        year = date.getFullYear(),
        hour = date.getHours(),
        minute = date.getMinutes();
    if( today == date.toDateString() ) var dateString = hour+":"+(minute<10?"0":"")+minute;
    else if( yesterday == date.toDateString() ) var dateString = "Gestern";
    else {
        var dateString = day+". "+monthNames[monthIndex];
        if( year != yearNow ) {
            dateString += " "+year;
        }
    }

    return dateString;
};

/////////////////////////////////////////
// selectFilename displays a filename input and selects the js filename
var selectFilename = function(input) {

    input.fadeIn();
    input.focus();
    var filename = input.val(),
        startPos = 0,
        endPos = filename.slice(-3) != ".js"? filename.length : filename.length-3;

    if (typeof input[0].selectionStart != "undefined") {
        input[0].selectionStart = startPos;
        input[0].selectionEnd = endPos;
    }
}

//////////////////////////////////////////
// WS.connect connects to server and loads code files
$WS.connect("ws://localhost:4000/socket", "{{ .xsrfdata }}", function() {

    if( !localStorage.userName || localStorage.userName === "" ) {
        
        liveEditor.editor.reset("");

    } else if( !localStorage.codeFileList || !localStorage.codeFileList.length) {
        $WS.sendMessage({
            Command: "readJSDir"
        }, function(message) {
            CPG_codeFileList = [];

            var files=[];
            for( file in message.Files ) {
                 files.push({ name: file, timeStamp: message.Files[file].TimeStamp });
            }

            files.sort(function(a, b) {
                if( a.timeStamp < b.timeStamp ) return 1;
                else return -1;
            });

            CPG_allFileList = files;
            localStorage.allFileList = JSON.stringify(CPG_allFileList);

            for( var i=0, codeFilesToRead=[] ; i<5 && i<files.length ; i++ ) {
                codeFilesToRead.push(files[i].name);
            }

            if( codeFilesToRead.length ) {
                $WS.sendMessage({
                    command: "readJSFiles",
                    FileNames: codeFilesToRead,
                }, function(message) {
                    for( var i=0 ; i<codeFilesToRead.length ; i++ ) {
                        var fileName = codeFilesToRead[i],
                            codeFile = message.CodeFiles[fileName];
                        if( codeFile ) {
                            CPG_codeFiles[fileName] = {
                                code: codeFile.Code,
                                timeStamp: codeFile.TimeStamp,
                            }
                            localStorage[fileName] = JSON.stringify(CPG_codeFiles[fileName]);
                            CPG_codeFileList.push(fileName);                            
                        }
                    }
                    localStorage.codeFileList = JSON.stringify(CPG_codeFileList);

                    localStorage.currentCodeFile = CPG_currentCodeFile = CPG_codeFileList[0];
                    $("#control-bar-input input").val(CPG_currentCodeFile);
                    fillButtonControl();

                    liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile].code);
                });
            } else {
                CPG_currentCodeFile = "{{ .ControlBarNewFile }}";
                CPG_codeFileList = [];
                CPG_codeFiles[CPG_currentCodeFile] = { code: "", timeStamp: null };

                localStorage.codeFileList = JSON.stringify(CPG_codeFileList);
                localStorage.currentCodeFile = CPG_currentCodeFile;
                localStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile]);

                $("#control-bar-input input").val(CPG_currentCodeFile);
                fillButtonControl();
                liveEditor.editor.reset("");
            }
        });
    } else {

        fillButtonControl();
        
        liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile]? CPG_codeFiles[CPG_currentCodeFile].code : "");
    }

    console.log("Websockets connected!");
});

///////////////////////////////////////////
// Delete button
$("#control-bar-delete").on('click', function() {
    if( CPG_currentCodeFile !== "{{ .ControlBarNewFile }}" ) {
        showModal(CPG_currentCodeFile, "{{ .ControlBarFileDelete }}", function(yes) {
            if( yes ) {
                $WS.sendMessage({
                    command: "deleteJSFiles",
                    FileNames: [CPG_currentCodeFile],
                }, function(message) {

                    // weiter mit go command deleteJSFiles
                    CPG_codeFileList.splice(CPG_codeFileList.indexOf(CPG_currentCodeFile),1);
                    CPG_allFileList.splice(CPG_allFileList.indexOf(CPG_currentCodeFile),1);
                    CPG_codeFiles[CPG_currentCodeFile] = null;

                    localStorage.currentCodeFile = CPG_currentCodeFile = CPG_codeFileList[0] || "{{ .ControlBarNewFile }}"
                    localStorage.codeFileList = JSON.stringify(CPG_codeFileList);
                    localStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile] || { code: "" });

                    fillButtonControl();
                    liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile]? CPG_codeFiles[CPG_currentCodeFile].code : "");
                });
            } else {
            }
        });
        return;

    }
});

$("#control-bar-new").on('click', function() {

    if( CPG_currentCodeFile !== "{{ .ControlBarNewFile }}" ) {
        storeCurrentCodeFile();
    }

    localStorage.currentCodeFile = CPG_currentCodeFile = "{{ .ControlBarNewFile }}";

    $("#control-bar-current-file").text(CPG_currentCodeFile);
    $("#control-bar-input input").val(CPG_currentCodeFile);
    liveEditor.editor.reset("");

    storeCurrentCodeFile();
});

var saveCodeFile = function(filename) {
    $("#control-bar-label").text("...");
    var code = liveEditor.editor.text();
    // Unbind any handlers this function may have set for previous
    // screenshots

    window.liveEditor.getScreenshot(function (data) {

        image = data.substr(data.search(",")+1);

        $WS.sendMessage({
            Command: "writeJSFiles",
            FileNames: [filename],
            CodeFiles: [code],
            Overwrite: CPG_currentCodeFile === filename,
            Images   : [image], 
        }, function(message) {
            if( message.Error ) {
                showModal("{{ .ControlBarFileExists }}", message.Error, function(yes) {
                    if( yes ) {
                        CPG_currentCodeFile = filename;
                        saveCodeFile(filename);
                    } else {
                        $("#control-bar-label").text("{{ .ControlBarLabel }}");
                    }
                });
                return;
            } else if( CPG_currentCodeFile !== filename ) {

                CPG_codeFiles[CPG_currentCodeFile].code = CPG_currentCodeFile !== "{{ .ControlBarNewFile }}"? liveEditor.editor.text() : "";
                localStorage[CPG_currentCodeFile] = JSON.stringify( CPG_codeFiles[CPG_currentCodeFile] );
                
                CPG_codeFileList.push(filename);
                localStorage.codeFileList = JSON.stringify( CPG_codeFileList );
                localStorage.currentCodeFile = CPG_currentCodeFile = filename;
            }

            CPG_codeFiles[filename] = { 
                code: liveEditor.editor.text(),
                timeStamp: message.TimeStamps[0]
            };
            localStorage[filename] = JSON.stringify(CPG_codeFiles[filename]);
            
            fillButtonControl();
            $("#control-bar-label").text("{{ .ControlBarSaved }}");
            setTimeout(function() { $("#control-bar-label").text("{{ .ControlBarLabel }}"); }, 2000);
        });
    });

    // Ask the frame for a screenshot
    postFrame({ screenshot: true });
};

$("#control-bar-save").on('click', function() {
    var input = $("#control-bar-input input"),
        filename = input.val();

    if( filename === "{{ .ControlBarNewFile }}") {
        selectFilename(input);
    } else {
        saveCodeFile(filename);
        input.fadeOut();
    }
});

$("#control-bar-saveas").on('click', function() {
    var input = $("#control-bar-input input");
    selectFilename(input);
});

$("#control-bar-input").submit(function(e) {
    var input = $("#control-bar-input input"),
        filename = input.val();

    if( filename === "{{ .ControlBarNewFile }}") {
        selectFilename(input);
    } else {

        if( filename.slice(-3) != ".js" ) {
            filename += ".js"
            input.val(filename);
        }

        saveCodeFile(filename);
        input.fadeOut();
    }

    return false;
});

$("#logout-button").on('click', function() {
    localStorage.userName = "";
});

window.onbeforeunload = function() {
    storeCurrentCodeFile();
    //return "You have attempted to leave this page.  If you have made any changes to the fields without clicking the Save button, your changes will be lost.  Are you sure you want to exit this page?";
}

setInterval(storeCurrentCodeFile, 30000)

})();
    </script>


</body>
</html>
