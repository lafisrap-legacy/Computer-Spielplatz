<!DOCTYPE html>
<html lang="de">
<head>
<title>{{ .Title }}</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="static/css/bootstrap.min.css">
<link rel="stylesheet" href="static/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="static/css/spielplatz.css">
<link rel="stylesheet" href="build/css/live-editor.core_deps.css"/>
<link rel="stylesheet" href="build/css/live-editor.audio.css"/>
<link rel="stylesheet" href="build/css/live-editor.tooltips.css"/>
<link rel="stylesheet" href="build/css/live-editor.ui.css"/>
<script src="static/js/jquery-2.1.4.min.js"></script>
<!-- Live editor script files-->
<script src="build/js/live-editor.core_deps.js"></script>
<script src="build/js/live-editor.editor_ace_deps.js"></script>
<script src="build/js/live-editor.audio.js"></script>
<!-- script src="build/js/live-editor.shared.js"></script -->
<script src="static/js/live-editor.shared.js"></script -->
<script src="build/js/live-editor.tooltips.js"></script>
<script src="build/js/live-editor.ui.js"></script>
<script src="build/js/live-editor.editor_ace.js"></script>
<!-- RIDDLE: Modal dialogs won't work if live-editor file are called after bootstrap.js -->
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/websockets.js"></script>
</head>
<body>
<div class="container">
    <div id="control-bar-yes-no-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">You forgot to set the title!</h4>
          </div>
          <div class="modal-body">
            <p>You forgot to set the body text&hellip;</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="modal-yes btn btn-default" data-dismiss="modal">{{ .ControlBarModalYes }}</button>
            <button type="button" class="modal-no btn btn-primary" data-dismiss="modal">{{ .ControlBarModalNo }}</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->    

    <div id="control-bar-codefile-modal" class="modal  fade">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">{{ .ControlBarModalCodefileTitle }}</h4>
          </div>
          <div class="modal-body">
          </div>
            <div class="clearfix"></div>
          <div class="modal-footer">
            <button type="button" class="modal-delete pull-left btn btn-default" data-dismiss="modal">{{ .ControlBarModalDelete }}</button>
            <button type="button" class="modal-open pull-right btn btn-primary" data-dismiss="modal">{{ .ControlBarModalOpen }}</button>
            <button type="button" class="modal-cancel pull-right btn btn-default" data-dismiss="modal">{{ .ControlBarModalCancel }}</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->    

    <div class="login-area">
        {{if not .UserName }}
            <a href="/login/live-editor" class="btn btn-info btn-sm pull-right">{{ .LoginLogin }} <span class="glyphicon glyphicon-share-alt"></span></a>
            <a href="/signup/live-editor" class="btn btn-info btn-sm pull-right">{{ .LoginSignup }} <span class="glyphicon glyphicon-book"></span></a>
        {{else}}
            <a href="/logout" id="logout-button" class="btn btn-info btn-sm pull-right">{{ .LoginLogout }} '{{ .UserName }}' <span class="glyphicon glyphicon-search"></span></a>        
        {{end}}
    </div>
    <div class="clearfix"></div>
    <div id="top-control-bar">
    </div>
    <div id="cpg-live-editor" class="span12"></div>
    {{ if .UserName }}
    <div id="bottom-control-bar">
        <button id="control-bar-new" class="btn btn-primary btn-sm">{{ .ControlBarNew }}</button>
        <span class="dropup">
            <button class="btn btn-primary dropdown-toggle btn-md" type="button" data-toggle="dropdown">
                <span id= "control-bar-current-file"></span>
                <span class="caret"></span></button>
                <ul id= "control-bar-files" class="dropdown-menu">
                </ul>
        </span>
        <button id="control-bar-delete" class="btn btn-primary btn-sm">{{ .ControlBarDelete }}</button>
        <button id="control-bar-restart" class="btn btn-primary btn-sm" style="float: right">{{ .ControlBarRestart }}</button>
        <span class="dropdown" style="float: right">
            <button class="btn btn-primary dropdown-toggle btn-md" type="button" data-toggle="dropdown">
                <span id="control-bar-label">{{ .ControlBarLabel }}</span> 
                <span id="control-bar-caret" class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a id="control-bar-save">{{ .ControlBarSave }}</a></li>
                    <li><a id="control-bar-saveas">{{ .ControlBarSaveAs }}</a></li>
                    <li><a id="control-bar-version">{{ .ControlBarVersion }}</a></li>
                    <li><a id="control-bar-history">{{ .ControlBarHistory }}</a></li>
                </ul>
        </span>
        <form id="control-bar-input" class="form-inline" role="form" action="" style="float:right">  
             <div class="form-group col-sm-3">
                 <input class="form-control" type="text" name="filename" value="{{ .ControlBarNewFile }}" placeholder="Description" style="display:none"/>
             </div>
        </form>
    </div>
  {{ else }}
    <div id="bottom-control-bar">
        <span class="label label-info">{{ .ControlBarNoUser }}</span>
    </div>  
  {{ end }}
</div>

<script>
(function() {

////////////////////////////////////////////////////////////////////////////////////////////////
// Live-Editor !
window.AllImages = JSON.parse({{ .AllImages }});
window.OutputImages = JSON.parse({{ .AllImages }});
window.liveEditor = new LiveEditor({
    el: $("#cpg-live-editor"),
    code: window.localStorage["test-code"] || "",
    width: 400,
    height: 400,
    editorHeight: "400px",
    autoFocus: true,
    workersDir: "../build/workers/",
    execFile: "external/output.html",
    externalsDir: "../build/external/",
    imagesDir: "static/userdata/{{ .UserName }}/images/",
    //imagesDir: "../build/images/",
    jshintFile: "../build/external/jshint/jshint.js"
});

$( ".scratchpad-toolbar" ).hide();

/////////////////////////////////////////////////////////////////////////////////////////////////
// Live Editor page logic
//
// If User changed: clear everything from localStorage
if( localStorage.userName !== "{{ .UserName }}") {
    var fileList = sessionStorage.codeFileList && JSON.parse(sessionStorage.codeFileList) || [];
    for( var i=0 ; i<fileList.length ; i++ ) sessionStorage.removeItem(fileList[i]);
    sessionStorage.removeItem("codeFileList");
    sessionStorage.removeItem("allFilesList");
    sessionStorage.removeItem("currentCodeFile");
    localStorage.userName = "{{ .UserName }}";
}

//////////////////////////////////////////
// Fill in the globals form local storage
var CPG_userName = localStorage.userName,
    CPG_codeFileList = sessionStorage.codeFileList && JSON.parse(sessionStorage.codeFileList) || [],
    CPG_allFilesList = sessionStorage.allFilesList && JSON.parse(sessionStorage.allFilesList) || [],
    CPG_currentCodeFile = sessionStorage.currentCodeFile,
    CPG_codeFiles = {};

for( var i=0 ; i<CPG_codeFileList.length ; i++ ) CPG_codeFiles[CPG_codeFileList[i]] = sessionStorage[CPG_codeFileList[i]] && JSON.parse(sessionStorage[CPG_codeFileList[i]]) || {};
CPG_codeFiles[{{ .ControlBarNewFile }}] = sessionStorage[{{ .ControlBarNewFile }}] && JSON.parse(sessionStorage[{{ .ControlBarNewFile }}]) || {};

///////////////////////////////////////////
// showModalYesNo displays a modal dialog with answers yes and no
var showModalYesNo = function(title, body, cb) {
    var modal = $("#control-bar-yes-no-modal");

    $(".modal-title", modal).text(title);
    $(".modal-body p", modal).text(body);
    $(".modal-yes", modal).off("click").one("click", function(e) {
        var lcb = cb;
        cb = null;
        modal.modal('hide');
        if( lcb ) lcb(true);
    });
    $(".modal-no", modal).off("click").one("click", function(e) {
        // cb is called on hide event
        modal.modal('hide');
    });

    modal.modal('show');
    modal.one('hidden.bs.modal', function(e) {
        if( cb ) cb(false);
    });
};

///////////////////////////////////////////
// showModalCodeFiles shows the code file info and modification dialog
var showModalCodeFiles = function(cb) {
    var modal = $("#control-bar-codefile-modal");

    var afl = CPG_allFilesList,
        files = $("<div id='modal-codefiles'>"),
        row = null;

    for( var i=0 ; i<afl.length ; i++ ) {
        files.append(
            "<div class='file file"+i+" pull-left' filename='"+afl[i].name+"'>"+
            "   <div class='top'>"+
            "   </div>"+
            "   <div class='middle'>"+
            "       <img src='static/userdata/{{.UserName}}/js/"+(afl[i].name.slice(0,-3)+".png")+"'>"+
            "   </div>"+
            "   <div class='bottom'>"+
            "       <span class='filename text-center'>"+afl[i].name+"</span>"+
            "       <span class='timestamp pull-left vbottom'>"+getFormatedDate(afl[i].timeStamp)+"</span>"+
            "       <input type='checkbox' class='checkbox large pull-right' value=''>"+
            "   </div>"+
            "</div>"
        );
    }
    
    // Correct font size of filenames
    $(".modal-body", modal ).html(files);
    modal.one('shown.bs.modal', function() {

        for( var i=0 ; i<afl.length ; i++ ) {
            var filename = $(".file"+i+" .filename", files),
                maxWidth = filename.width(),
                realWidth = filename[0].scrollWidth;

            if( realWidth > maxWidth ) {
                var fontSize = parseFloat(filename.css("font-size"));

                for( var j=1 ; j<10 ; j++ ) {
                    filename.css("font-size", (fontSize - j));
                    if( filename[0].scrollWidth <= maxWidth ) break;
                }
            }
        }
    });

    /*
    $(".file .middle", modal).one("dblclick", function(e) {
        cb("open", [$(this).parent().attr("filename")]);
        cb = null;
        modal.modal('hide');
    });
    */

    $(".file .middle", modal).on("click", function(e) {
        var checkbox = $(".checkbox", $(this).parent()); 
        checkbox.prop("checked", !checkbox.prop("checked"));
    });

    var getCheckedFilenames = function() { 
        var filenames = [];
        $.each($(".file", modal), function( index, file ) {
            var checkbox = $(".checkbox", $(this))
            if( checkbox.is(':checked')) {
                filenames.push($(this).attr("filename"));
            }
        });
        return filenames;
    }

    $(".modal-open", modal).off("click").one("click", function(e) {

        var lcb = cb;
        cb = null;
        modal.modal('hide');

        //if( !lcb ) debugger;
        if( lcb ) lcb("open", getCheckedFilenames());
    });

    $(".modal-cancel", modal).off("click").one("click", function(e) {
        modal.modal('hide');
    });

    $(".modal-delete", modal).off("click").one("click", function(e) {
        var lcb = cb;
        cb = null;
        modal.modal('hide');

        //if( !lcb ) debugger;
        if( lcb ) lcb("delete", getCheckedFilenames());
    });

    modal.one('hidden.bs.modal', function(e) {
        if( cb ) cb("cancel");
    });

    modal.modal('show');
};

////////////////////////////////////////////
// storeCurrentCodeFile syncs the current code file with the global variable and the local storage
var storeCurrentCodeFile = function() {
    if( CPG_currentCodeFile ) {
        CPG_codeFiles[CPG_currentCodeFile].code = liveEditor.editor.text();
        sessionStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile]);            
    }
};

/////////////////////////////////////////////
// fillButtonControl fills the file select button with current files
var fillButtonControl = function() {

    // create file list for button control
    var fileList = [];
    for( var i=0 ; i<CPG_codeFileList.length ; i++ ) {
        fileList.push({
            fileName: CPG_codeFileList[i],
            timeStamp: CPG_codeFiles[CPG_codeFileList[i]].timeStamp
        });
    }

    fileList.sort(function(a,b) {
        if( a.timeStamp > b.timeStamp ) return -1;
        else return 1;
    });

    var cbf = $("#control-bar-files"),
        width = cbf.width();

    cbf.html("");
    for( var i=0 ; i<fileList.length ; i++ ) {

        cbf.append('<li class="control-bar-file" codefile="'+fileList[i].fileName+'"><span>'+fileList[i].fileName+'</span><span class="timestamp">'+getFormatedDate(fileList[i].timeStamp)+'</span></li>')
            .width(width + 20); 
    }

    if( CPG_allFilesList.length >= 2 ) {
        cbf.append('<li class="border-top control-bar-file" codefile="all"><span>{{ .ControlBarAllFiles }}</span></li>')
    }

    $("#control-bar-current-file").text(CPG_currentCodeFile);
    $("#control-bar-input input").val(CPG_currentCodeFile);

    $(".control-bar-file").on('click', function(e) {
        if( CPG_currentCodeFile !== "{{ .ControlBarNewFile }}" ) {
            storeCurrentCodeFile();
        }

        var codeFile = $(this).attr("codeFile");
 
        if( codeFile !== "all" ) {
            sessionStorage.currentCodeFile = CPG_currentCodeFile = codeFile;
            $("#control-bar-current-file").text(CPG_currentCodeFile);
            $("#control-bar-input input").val(CPG_currentCodeFile)
            liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile].code);
        } else {
            showModalCodeFiles(function(button, selFiles) {
                switch( button ) {
                    /////////////////////////////////////////////////
                    // User selected "open"
                    case "open":
                        for( var i=0, openFiles=[] ; i<selFiles.length ; i++ ) {
                            if( CPG_codeFileList.indexOf(selFiles[i]) !== -1 ) openFiles.push(selFiles[i]);
                        }

                        var readFiles = function() {
                            if( selFiles.length ) {
                                $WS.sendMessage({
                                    command: "readJSFiles",
                                    FileNames: selFiles,
                                }, function(message) {
                                    for( var i=0 ; i<selFiles.length ; i++ ) {
                                        var fileName = selFiles[i],
                                            codeFile = message.CodeFiles[fileName];
                                        if( codeFile ) {
                                            CPG_codeFiles[fileName] = {
                                                code: codeFile.Code,
                                                timeStamp: codeFile.TimeStamp,
                                            }
                                            sessionStorage[fileName] = JSON.stringify(CPG_codeFiles[fileName]);
                                            if( CPG_codeFileList.indexOf(fileName) === -1 ) CPG_codeFileList.push(fileName);
                                        }
                                    }
                                    sessionStorage.codeFileList = JSON.stringify(CPG_codeFileList);

                                    sessionStorage.currentCodeFile = CPG_currentCodeFile = selFiles[0];
                                    $("#control-bar-input input").val(CPG_currentCodeFile);
                                    fillButtonControl();

                                    liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile].code);
                                });
                            }
                        }

                        if( openFiles.length ) {
                            showModalYesNo(openFiles.join("   "), openFiles.length === 1?"{{ .ControlBarModalAlreadyOpenS }}":"{{ .ControlBarModalAlreadyOpenP }}", function(yes) {
                                if( !yes ) {
                                    for( var i=openFiles.length-1 ; i>=0 ; i-- ) selFiles.splice(selFiles.indexOf(openFiles[i]),1);
                                }

                                readFiles();
                            });
                        } else {
                            readFiles();
                        }
                        break;
                    /////////////////////////////////////////////////
                    // User selected "cancel" or closed the dialog
                    case "cancel":
                        break;
                    /////////////////////////////////////////////////
                    // User selected "delete"
                    case "delete":
                        if( selFiles.length ) {
                            showModalYesNo(selFiles.join("   "), selFiles.length === 1? "{{ .ControlBarModalFileDeleteS }}" : "{{ .ControlBarModalFileDeleteP }}", function(yes) {
                                if( yes ) {
                                    $WS.sendMessage({
                                        command: "deleteJSFiles",
                                        FileNames: selFiles,
                                    }, function(message) {

                                        // Todo: Error message
                                        //if( message.Error ) return;

                                        for( var i=selFiles.length-1 ; i>=0 ; i-- ) {
                                            // hier wird ab und zu ein Wort nicht aus allFiles gelöscht ... (step debug!!)

                                            CPG_codeFileList.splice(CPG_codeFileList.indexOf(selFiles[i]),1);
                                            for( var afl=CPG_allFilesList, j=afl.length-1 ; j>=0 ; j-- ) {
                                                if( afl[j].name === selFiles[i] ) {
                                                    afl.splice(j,1);
                                                    break;
                                                }
                                            } 
                                            CPG_codeFiles[selFiles[i]] = null;

                                            if( selFiles[i] === CPG_currentCodeFile ) sessionStorage.currentCodeFile = CPG_currentCodeFile = CPG_codeFileList[0] || "{{ .ControlBarNewFile }}"
                                        }
                                        sessionStorage.allFilesList = JSON.stringify(CPG_allFilesList);
                                        sessionStorage.codeFileList = JSON.stringify(CPG_codeFileList);
                                        sessionStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile] || { code: "" });

                                        fillButtonControl();
                                        liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile]? CPG_codeFiles[CPG_currentCodeFile].code : "");
                                    });
                                }
                            });
                            return;

                        }
                        break;
                }
            });
        }
    });
};

///////////////////////////////////////////
// getFormatedDate returns a neatly formated date or time
var getFormatedDate = function(time) {
    if( !time ) return "";

    var monthNames = ["Jan.", "Feb.", "März", "Apr.", "Mai", "Juni", "Juli", "Aug.", "Sep.", "Okt.", "Nov.", "Dez."];

    var date = new Date(),
        today = date.toDateString(),
        yearNow = date.getFullYear(),
        yesterday = date.setDate(date.getDate()-1);
    yesterday = date.toDateString();

    date.setTime(time);
    var day = date.getDate(),
        monthIndex = date.getMonth(),
        year = date.getFullYear(),
        hour = date.getHours(),
        minute = date.getMinutes();
    if( today == date.toDateString() ) var dateString = hour+":"+(minute<10?"0":"")+minute;
    else if( yesterday == date.toDateString() ) var dateString = "Gestern";
    else {
        var dateString = day+". "+monthNames[monthIndex];
        if( year != yearNow ) {
            dateString += " "+year;
        }
    }

    return dateString;
};

/////////////////////////////////////////
// selectFilename displays a filename input and selects the js filename
var selectFilename = function(input) {

    input.fadeIn();
    input.focus();
    var filename = input.val(),
        startPos = 0,
        endPos = filename.slice(-3) != ".js"? filename.length : filename.length-3;

    if (typeof input[0].selectionStart != "undefined") {
        input[0].selectionStart = startPos;
        input[0].selectionEnd = endPos;
    }
}

//////////////////////////////////////////
// WS.connect connects to server and loads code files
$WS.connect("ws://localhost:4000/socket", "{{ .xsrfdata }}", function() {

    if( !localStorage.userName || localStorage.userName === "" ) {
        
        liveEditor.editor.reset("");

    } else if( !sessionStorage.codeFileList || !sessionStorage.codeFileList.length) {
        $WS.sendMessage({
            Command: "readJSDir"
        }, function(message) {
            CPG_codeFileList = [];

            var files=[];
            for( file in message.Files ) {
                 files.push({ name: file, timeStamp: message.Files[file].TimeStamp });
            }

            files.sort(function(a, b) {
                if( a.timeStamp < b.timeStamp ) return 1;
                else return -1;
            });

            CPG_allFilesList = files;
            sessionStorage.allFilesList = JSON.stringify(CPG_allFilesList);

            for( var i=0, codeFilesToRead=[] ; i<5 && i<files.length ; i++ ) {
                codeFilesToRead.push(files[i].name);
            }

            if( codeFilesToRead.length ) {
                $WS.sendMessage({
                    command: "readJSFiles",
                    FileNames: codeFilesToRead,
                }, function(message) {
                    for( var i=0 ; i<codeFilesToRead.length ; i++ ) {
                        var fileName = codeFilesToRead[i],
                            codeFile = message.CodeFiles[fileName];
                        if( codeFile ) {
                            CPG_codeFiles[fileName] = {
                                code: codeFile.Code,
                                timeStamp: codeFile.TimeStamp,
                            }
                            sessionStorage[fileName] = JSON.stringify(CPG_codeFiles[fileName]);
                            CPG_codeFileList.push(fileName);                            
                        }
                    }
                    sessionStorage.codeFileList = JSON.stringify(CPG_codeFileList);

                    sessionStorage.currentCodeFile = CPG_currentCodeFile = CPG_codeFileList[0];
                    $("#control-bar-input input").val(CPG_currentCodeFile);
                    fillButtonControl();

                    liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile].code);
                });
            } else {
                CPG_currentCodeFile = "{{ .ControlBarNewFile }}";
                CPG_codeFileList = [];
                CPG_codeFiles[CPG_currentCodeFile] = { code: "", timeStamp: null };

                sessionStorage.codeFileList = JSON.stringify(CPG_codeFileList);
                sessionStorage.currentCodeFile = CPG_currentCodeFile;
                sessionStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile]);

                $("#control-bar-input input").val(CPG_currentCodeFile);
                fillButtonControl();
                liveEditor.editor.reset("");
            }
        });
    } else {

        fillButtonControl();
        
        liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile]? CPG_codeFiles[CPG_currentCodeFile].code : "");
    }

    console.log("Websockets connected!");
});

///////////////////////////////////////////
// Delete button
$("#control-bar-delete").on('click', function() {
    if( CPG_currentCodeFile !== "{{ .ControlBarNewFile }}" ) {
        showModalYesNo(CPG_currentCodeFile, "{{ .ControlBarModalFileDeleteS }}", function(yes) {
            if( yes ) {
                $WS.sendMessage({
                    command: "deleteJSFiles",
                    FileNames: [CPG_currentCodeFile],
                }, function(message) {

                    // weiter mit go command deleteJSFiles
                    CPG_codeFileList.splice(CPG_codeFileList.indexOf(CPG_currentCodeFile),1);
                    for( var i=0, afl=CPG_allFilesList ; i<afl.length ; i++ ) {
                        if( afl[i].name === CPG_currentCodeFile ) afl.splice(i,1);
                        break;
                    } 
                    CPG_codeFiles[CPG_currentCodeFile] = null;

                    sessionStorage.currentCodeFile = CPG_currentCodeFile = CPG_codeFileList[0] || "{{ .ControlBarNewFile }}"
                    sessionStorage.codeFileList = JSON.stringify(CPG_codeFileList);
                    sessionStorage.allFilesList = JSON.stringify(CPG_allFilesList);
                    sessionStorage[CPG_currentCodeFile] = JSON.stringify(CPG_codeFiles[CPG_currentCodeFile] || { code: "" });

                    fillButtonControl();
                    liveEditor.editor.reset(CPG_codeFiles[CPG_currentCodeFile]? CPG_codeFiles[CPG_currentCodeFile].code : "");
                });
            }
        });
        return;
    }
});

$("#control-bar-new").on('click', function() {

    if( CPG_currentCodeFile !== "{{ .ControlBarNewFile }}" ) {
        storeCurrentCodeFile();
    }

    sessionStorage.currentCodeFile = CPG_currentCodeFile = "{{ .ControlBarNewFile }}";

    $("#control-bar-current-file").text(CPG_currentCodeFile);
    $("#control-bar-input input").val(CPG_currentCodeFile);
    liveEditor.editor.reset("");

    storeCurrentCodeFile();
});

var saveCodeFile = function(filename) {
    $("#control-bar-label").text("...");
    var code = liveEditor.editor.text();
    // Unbind any handlers this function may have set for previous
    // screenshots

    window.liveEditor.getScreenshot(function (data) {

        // remove BASE64-HTML header
        image = data.substr(data.search(",")+1);

        $WS.sendMessage({
            Command: "writeJSFiles",
            FileNames: [filename],
            TimeStamps: CPG_codeFiles[filename] && [CPG_codeFiles[filename].timeStamp] || null,
            CodeFiles: [code],
            Overwrite: CPG_currentCodeFile === filename,
            Images   : [image], 
        }, function(message) {
            if( message.Error ) {
                showModalYesNo("{{ .ControlBarModalFileExists }}", message.Error, function(yes) {
                    if( yes ) {
                        CPG_currentCodeFile = filename;
                        saveCodeFile(filename);
                    } else {
                        $("#control-bar-label").text("{{ .ControlBarLabel }}");
                    }
                });
                return false;
            } else if( CPG_currentCodeFile !== filename ) {

                CPG_codeFiles[CPG_currentCodeFile].code = CPG_currentCodeFile !== "{{ .ControlBarNewFile }}"? liveEditor.editor.text() : "";
                
                CPG_codeFileList.push(filename);
                for( var i=0, filenameExists=false, afl=CPG_allFilesList ; i<afl.length ; i++ ) {
                    if( afl[i].name === filename ) {
                        filenameExists = true;
                        break;
                    }
                }
                if( !filenameExists ) CPG_allFilesList.push({
                    name: filename,
                    timeStamp: CPG_codeFiles[CPG_currentCodeFile].timeStamp
                });
                sessionStorage[CPG_currentCodeFile] = JSON.stringify( CPG_codeFiles[CPG_currentCodeFile] );
                sessionStorage.codeFileList = JSON.stringify(CPG_codeFileList);
                sessionStorage.allFilesList = JSON.stringify(CPG_allFilesList);
                sessionStorage.currentCodeFile = CPG_currentCodeFile = filename;
            } else if(message.OutdatedTimeStamps.length > 0) {
                showModalYesNo(filename, "{{ .ControlBarModalFileOutdated }}", function(yes) {
                    if( yes ) {
                        CPG_codeFiles[filename].timeStamp = message.OutdatedTimeStamps[0] 
                        saveCodeFile(filename);
                    } else {
                        $("#control-bar-label").text("{{ .ControlBarLabel }}");
                    }
                });
                return false;
            } 

            CPG_codeFiles[filename] = { 
                code: liveEditor.editor.text(),
                timeStamp: message.SavedTimeStamps[0]
            };
            sessionStorage[filename] = JSON.stringify(CPG_codeFiles[filename]);
            fillButtonControl();
            $("#control-bar-label").text("{{ .ControlBarSaved }}").parent().removeClass("btn-primary").addClass("btn-success");
            $
            setTimeout(function() { 
                $("#control-bar-label").text("{{ .ControlBarLabel }}")
                    .parent().addClass("btn-primary")
                    .removeClass("btn-success"); 
            }, 2000);
        });
    });
};

$("#control-bar-save").on('click', function(e) {
    var input = $("#control-bar-input input"),
        filename = input.val();

    if( filename === "{{ .ControlBarNewFile }}") {
        selectFilename(input);
    } else {
        saveCodeFile(filename);
        input.fadeOut();
    }

    return false;
});

$("#control-bar-label").on('click', function(e) {
    $("#control-bar-save").trigger("click");
    e.stopPropagation()
});

$("#control-bar-saveas").on('click', function() {
    var input = $("#control-bar-input input");
    selectFilename(input);
});

$("#control-bar-input").submit(function(e) {
    var input = $("#control-bar-input input"),
        filename = input.val();

    if( filename === "{{ .ControlBarNewFile }}") {
        selectFilename(input);
    } else {

        if( filename.slice(-3) != ".js" ) {
            filename += ".js"
            input.val(filename);
        }

        saveCodeFile(filename);
        input.fadeOut();
    }

    return false;
});


$("#control-bar-restart").on("click", function(e) {
    window.liveEditor.restartCode();
});


$("#logout-button").on('click', function() {
    localStorage.userName = "";
});

window.onbeforeunload = function() {
    storeCurrentCodeFile();
    //return "You have attempted to leave this page.  If you have made any changes to the fields without clicking the Save button, your changes will be lost.  Are you sure you want to exit this page?";
}

$("#cpg-live-editor").blur(function(e) {
    console.log("Going away to next tab");
    // Do Blur Actions Here
});

$("#cpg-live-editor").focus(function(e) {
    console.log("Coming back from other tab.");
    // Do Focus Actions Here
});

$(window).on('hashchange', function(e){
    console.log("URL changed.");
    // do something...
});

setInterval(storeCurrentCodeFile, 30000)

})();
    </script>


</body>
</html>
