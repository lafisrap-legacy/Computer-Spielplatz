<!DOCTYPE html>
<html lang="de">
<head>
<title>{{ .Title }}</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="static/css/bootstrap.min.css">
<link rel="stylesheet" href="static/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="static/css/spielplatz.css">
<link rel="stylesheet" href="build/css/live-editor.core_deps.css"/>
<link rel="stylesheet" href="build/css/live-editor.audio.css"/>
<link rel="stylesheet" href="build/css/live-editor.tooltips.css"/>
<link rel="stylesheet" href="build/css/live-editor.ui.css"/>
<script src="static/js/jquery-2.1.4.min.js"></script>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/websockets.js"></script>
</head>
<body>
<div class="container">
    <div class="login-area">
        {{if not .UserName }}
            <a href="/login/live-editor" class="btn btn-info btn-sm pull-right">{{ .LoginLogin }} <span class="glyphicon glyphicon-share-alt"></span></a>
            <a href="/signup/live-editor" class="btn btn-info btn-sm pull-right">{{ .LoginSignup }} <span class="glyphicon glyphicon-book"></span></a>
        {{else}}
            <a href="/logout" id="logout-button" class="btn btn-info btn-sm pull-right">{{ .LoginLogout }} '{{ .UserName }}' <span class="glyphicon glyphicon-search"></span></a>        
        {{end}}
    </div>
    <div class="clearfix"></div>
    <div id="top-control-bar">
    </div>
    <div id="sample-live-editor" class="span12"></div>
    {{ if .UserName }}
    <div id="bottom-control-bar">
        <button id="control-bar-prev" class="btn btn-primary btn-sm">{{ .ControlBarNew }}</button>
        <span class="dropdown">
            <button class="btn btn-primary dropdown-toggle btn-md" type="button" data-toggle="dropdown">
                <span id= "control-bar-current-file"></span>
                <span class="caret"></span></button>
                <ul id= "control-bar-files" class="dropdown-menu">
                </ul>
        </span>
        <button id="control-bar-next" class="btn btn-primary btn-sm">{{ .ControlBarDelete }}</button>
        <span class="dropdown" style="float: right">
            <button class="btn btn-primary dropdown-toggle btn-md" type="button" data-toggle="dropdown"><span id= "control-bar-label">{{ .ControlBarLabel }}</span>
                <span class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a id="control-bar-save">{{ .ControlBarSave }}</a></li>
                    <li><a id="control-bar-saveas">{{ .ControlBarSaveAs }}</a></li>
                    <li><a id="control-bar-version">{{ .ControlBarVersion }}</a></li>
                    <li><a id="control-bar-history">{{ .ControlBarHistory }}</a></li>
                </ul>
        </span>
        <form id="control-bar-input" class="form-inline" role="form" action="" style="float:right">  
             <div class="form-group col-sm-3">
                 <input class="form-control" type="text" name="filename" value="{{ .ControlBarNewFile }}" placeholder="Description" style="display:none"/>
             </div>
        </form>
  </div>
  {{ else }}
    <div id="bottom-control-bar">
        <span class="label label-info">{{ .ControlBarNoUser }}</span>
    </div>  
  {{ end }}
</div>

    <!-- The Live-Editor files -->
    <script src="build/js/live-editor.core_deps.js"></script>
    <script src="build/js/live-editor.editor_ace_deps.js"></script>
    <script src="build/js/live-editor.audio.js"></script>
    <script src="build/js/live-editor.shared.js"></script>
    <script src="build/js/live-editor.tooltips.js"></script>
    <script src="build/js/live-editor.ui.js"></script>
    <script src="build/js/live-editor.editor_ace.js"></script>

    <!-- The actual slides -->
    <script src="static/js/slides.js"></script>
    <script>
(function() {

window.liveEditor = new LiveEditor({
    el: $("#sample-live-editor"),
    code: window.localStorage["test-code"] || "",
    width: 400,
    height: 400,
    editorHeight: "400px",
    autoFocus: true,
    workersDir: "../build/workers/",
    execFile: "external/output.html",
    externalsDir: "../build/external/",
    imagesDir: "../build/images/",
    jshintFile: "../build/external/jshint/jshint.js"
});

var userName = "{{ .UserName }}",
    userData = localStorage.userData && JSON.parse(localStorage.userData) || {},
    currentCodeFile = localStorage.currentCodeFile || "{{ .ControlBarNewFile }}";

if( localStorage.userName !== userName || userName === "") {
    localStorage.userName = userName;
    localStorage.userData = "";
}

var fillButtonControl = function() {

    // create file list for button control
    var fileList = [];
    for( var file in userData.codeFiles ) {
        fileList.push({ 
            fileName: file,
            timeStamp: userData.codeFiles[file].TimeStamp
        });
    }

    fileList.sort(function(a,b) {
        if( a.timeStamp > b.timeStamp ) return -1;
        else return 1;
    });

    var cbf = $("#control-bar-files"),
        width = cbf.width();

    cbf.html("");
    for( var i=0 ; i<fileList.length ; i++ ) {

        cbf.append('<li><span class="control-bar-file" codefile="'+fileList[i].fileName+'">'+fileList[i].fileName+'<span class="timestamp">'+getFormatedDate(fileList[i].timeStamp)+'</span></span></li>')
            .width(width + 20); 
    }
    $("#control-bar-current-file").text(currentCodeFile);
    $("#control-bar-input input").val(currentCodeFile);

    $(".control-bar-file").on('click', function(e) {
        localStorage.currentCodeFile = currentCodeFile = $(this).attr("codeFile");
        $("#control-bar-current-file").text(currentCodeFile);
        $("#control-bar-input input").val(currentCodeFile);
        liveEditor.editor.reset(userData.codeFiles[currentCodeFile].Code);
    });
};

var getFormatedDate = function(time) {
    var monthNames = ["Jan.", "Feb.", "MÃ¤rz", "Apr.", "Mai", "Juni", "Juli", "Aug.", "Sep.", "Okt.", "Nov.", "Dez."];

    var date = new Date(),
        today = date.toDateString(),
        yearNow = date.getFullYear(),
        yesterday = date.setDate(date.getDate()-1);
    yesterday = date.toDateString();

    date.setTime(time);
    var day = date.getDate(),
        monthIndex = date.getMonth(),
        year = date.getFullYear(),
        hour = date.getHours(),
        minute = date.getMinutes();
    if( today == date.toDateString() ) var dateString = hour+":"+(minute<10?"0":"")+minute;
    else if( yesterday == date.toDateString() ) var dateString = "Gestern";
    else {
        var dateString = day+". "+monthNames[monthIndex];
        if( year != yearNow ) {
            dateString += " "+year;
        }
    }

    return dateString;
};

$WS.connect("ws://localhost:4000/socket", "{{ .xsrfdata }}", function() {

    if( localStorage.userData === "" && localStorage.userName !== "") {
        $WS.sendMessage({
            Command: "readJSDir"
        }, function(message) {
            userData = {codeFiles: {}}
            localStorage.userDir = JSON.stringify(message.Files);

            var codeFiles=[];
            for( file in message.Files ) {
                 codeFiles.push({ name: file, timeStamp: message.Files[file].TimeStamp });
            }

            codeFiles.sort(function(a, b) {
                if( a.timeStamp < b.timeStamp ) return 1;
                else return -1;
            });

            for( var i=0, codeFilesToRead=[] ; i<5 ; i++ ) {
                codeFilesToRead.push(codeFiles[i].name);
            }

            if( codeFilesToRead.length ) {
                $WS.sendMessage({
                    command: "readJSFiles",
                    FileNames: codeFilesToRead,
                }, function(message) {
                    userData.codeFiles = message.CodeFiles;
                    localStorage.userData = JSON.stringify(userData);

                    localStorage.currentCodeFile = currentCodeFile = codeFilesToRead[0];
                    $("#control-bar-input input").val(currentCodeFile);
                    fillButtonControl();

                    liveEditor.editor.reset(userData.codeFiles[currentCodeFile].Code);
                });
            }
        });
    } else {
        fillButtonControl();
        
        liveEditor.editor.reset(currentCodeFile === "{{ .ControlBarNewFile }}"? "": userData.codeFiles[currentCodeFile].Code);
    }

    console.log("Websockets connected!");
});

var stringifyTestCode = function(codeStrOrFunc) {
    if (!_.isString(codeStrOrFunc)) {
        codeStrOrFunc = codeStrOrFunc.toString()
            .replace(/^function\s\(\)\s\{/gi, "")
            .replace(/\}$/gi, "");
    }

    return codeStrOrFunc;

};

$("#control-bar-delete")
    .on('click', function() {
    });

$("#control-bar-new")
    .on('click', function() {
    });

$("#control-bar-save").on('click', function() {
    var input = $("#control-bar-input input"),
        filename = input.val();

    if( filename === "{{ .ControlBarNewFile }}") {
        input.fadeIn();
        input.focus();
    } else {
        input.fadeOut();
        $("#control-bar-label").text("...");
        $WS.sendMessage({
            Command: "writeJSFiles",
            FileNames: [filename],
            CodeFiles: [liveEditor.editor.text()]
        }, function(message) {
            userData.codeFiles[filename].TimeStamp = message.TimeStamps[0];
            fillButtonControl();
            $("#control-bar-label").text("{{ .ControlBarSaved }}");
            setTimeout(function() { $("#control-bar-label").text("{{ .ControlBarLabel }}"); }, 2000);
            console.log(JSON.stringify(message));
        });
    }
});

$("#control-bar-saveas").on('click', function() {
    var input = $("#control-bar-input input");
    input.fadeIn();
    input.focus();
});

$("#control-bar-input").submit(function(e) {
    var input = $("#control-bar-input input"),
        filename = input.val();

    if( filename.slice(-3) != ".js" ) {
        filename += ".js"
        input.val(filename);
    }

    $WS.sendMessage({
        Command: "writeJSFiles",
        FileNames: [filename],
        CodeFiles: [liveEditor.editor.text()]
    }, function(message) {
        $("#control-bar-label").text("{{ .ControlBarSaved }}");
        setTimeout(function() { $("#control-bar-label").text("{{ .ControlBarLabel }}"); }, 2000);
    });
    
    input.fadeOut();

    return false;
});

$("#logout-button").on('click', function() {
    localStorage.userData = "";
    localStorage.userName = "";
});

window.onbeforeunload = function() {
    //return "You have attempted to leave this page.  If you have made any changes to the fields without clicking the Save button, your changes will be lost.  Are you sure you want to exit this page?";
}

})();
    </script>


</body>
</html>
